<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>강남구 화재 피해 규모 예측 (Google Maps)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>강남구 건물 화재 피해 규모 예측</h1>
        <p>지도 위의 붉은색 건물 마커를 클릭하면 예상 피해 규모 점수를 확인할 수 있습니다.</p>

        <div id="map"></div>

        <div class="info-box">
            <h2>예측 결과</h2>
            <p id="address"><strong>주소:</strong> 지도의 마커를 클릭해주세요.</p>
            <p id="prediction"><strong>예상 피해 규모:</strong> -</p>
        </div>
    </div>

    <script>
        // --- JavaScript 코드 시작 ---

        const addressEl = document.getElementById('address');
        const predictionEl = document.getElementById('prediction');

        // Google Maps 초기화 함수
        function initMap() {
            const gangnamStation = { lat: 37.5172, lng: 127.0473 }; // 강남구청 중심 좌표

            // 지도 생성
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: gangnamStation,
            });

            // 백엔드 서버로부터 건물 데이터를 가져옵니다.
            fetch('/api/buildings')
                .then(response => response.json())
                .then(buildings => {
                    // 가져온 건물 데이터 각각에 대해 마커를 생성합니다.
                    buildings.forEach((building, index) => {
                        const markerPosition = { lat: building.lat, lng: building.lng };

                        const marker = new google.maps.Marker({
                            position: markerPosition,
                            map: map,
                            title: building.주소 || '주소 정보 없음'
                        });

                        // 마커에 클릭 이벤트를 등록합니다
                        marker.addListener('click', () => {
                            // 정보창 내용 업데이트
                            addressEl.innerHTML = `<strong>주소:</strong> ${building.주소 || '정보 없음'}`;
                            predictionEl.innerHTML = '<strong>예상 피해 규모:</strong> 계산 중...';

                            // 백엔드 서버의 /api/predict로 예측을 요청합니다.
                            fetch('/api/predict', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ index: index })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.error) {
                                    predictionEl.innerHTML = `<strong style="color: red;">오류:</strong> ${data.error}`;
                                } else {
                                    predictionEl.innerHTML = `<strong>예상 피해 규모:</strong> <span class="score">${data.prediction.toFixed(2)} 점</span>`;
                                }
                            })
                            .catch(error => {
                                predictionEl.innerHTML = '<strong style="color: red;">오류:</strong> 예측 요청에 실패했습니다.';
                                console.error('Prediction Error:', error);
                            });
                        });
                    });
                })
                .catch(error => {
                    console.error('Error fetching buildings:', error);
                    alert('지도에 표시할 건물 데이터를 가져오는 데 실패했습니다.');
                });
        }
    </script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCQWM6dFymuis1oh9DelTIPFO1igh1nVuo&callback=initMap">
    </script>
</body>
</html>